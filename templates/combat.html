{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- link de base -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/fontawesome-all.min.css' %}">
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <!-- Titre -->
    <title>House of tanks</title>
</head>
<body>
<header>
    <h1 class="text-center">House of tanks : {{ tank.username }}</h1>
</header>
<div class="container">
    <div class="row">
        <div class="col">
            <div class="card center">
                <h5 class="card-title text-center">Tank Infos</h5>
                <div class="card-body">
                    <p class="card-text">Ip adress : {{ tank.ip_adress }}</p>
                    <p class="card-text">Tank ID : {{ tank.tid }}</p>
                    <p class="card-text">Pv : <div id="pv">{{ tank.pv }}</div></p>
                    <p class="card-text">Shield : <div id="shield">{{ tank.shield }}</div></p>
                    <table>
                        <tbody>
                        <tr>
                            <td></td>
                            <td>
                                <button class="btn btn-secondary fa-solid fa-arrow-up" onmousedown="sendMove('up')" onmouseup="sendStop()"></button>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>
                                <button class="btn btn-secondary fa-solid fa-arrow-left" onmousedown="sendMove('left')" onmouseup="sendStop()"></button>
                            </td>
                            <td></td>
                            <td>
                                <button class="btn btn-secondary fa-solid fa-arrow-right" onmousedown="sendMove('right')" onmouseup="sendStop()"></button>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>
                                <button class="btn btn-secondary fa-solid fa-arrow-down" onmousedown="sendMove('down')" onmouseup="sendStop()"></button>
                            </td>
                            <td></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    <!-- Shot -->
                    <button class="btn btn-secondary" onclick="sendConnection()">Connection</button>
                    <br>
                    <!-- Shot -->
                    <button class="btn btn-secondary" onclick="sendShoot()">SHOOT</button>
                    <br>
                    <!-- Msg -->
                    <h5>Messages</h5>
                    <div id="msg"></div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card center">
                <h5 class="card-title text-center">Camera</h5>
                <div class="card-body">
                    <p class="card-text">Voici votre vue</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card">
                <h5 class="card-title text-center">Magasin</h5>
                <div class="card-body">
                    <!--Argent-->
                    <p>Argent : {{ tank.money }}</p>
                    <!--Arme-->
                    <p>Votre arme : {{ tank.weapon_selected.nom }}</p>
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Degats</th>
                            <th>Durabilit√©e</th>
                            <th>Precision</th>
                            <th>Prix</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for weapon in tank.weapon_list %}
                            <tr>
                                <td>{{ weapon.nom }}</td>
                                <td>{{ weapon.degats }}</td>
                                <td>{{ weapon.durabilite }}</td>
                                <td>{{ weapon.precision }}</td>
                                <td>{{ weapon.price }}</td>
                                <td>
                                    {% if weapon.nom != tank.weapon_selected.nom %}
                                    <form method="post">
                                        {% csrf_token %}
                                        <input class="form-control m-2" type="hidden"
                                               placeholder="price_weapon" name="price_weapon" value="{{ weapon.price }}">
                                        <input class="form-control m-2" type="hidden"
                                               placeholder="weapon_nom" name="weapon_nom" value="{{ weapon.nom }}">
                                        <button class="btn btn-outline-secondary" type="submit">Buy</button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <!--Bouclier-->
                    <p>Votre bouclier : {{ tank.shield_selected.nom }}</p>
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Valeur</th>
                                <th>Prix</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for shield in tank.shield_list %}
                                <tr>
                                    <td>{{ shield.nom }}</td>
                                    <td>{{ shield.valeur }}</td>
                                    <td>{{ shield.price }}</td>
                                    <td>
                                    <form method="post">
                                        {% csrf_token %}
                                        <input class="form-control m-2" type="hidden"
                                               placeholder="price_shield" name="price_shield" value="{{ shield.price }}">
                                        <input class="form-control m-2" type="hidden"
                                               placeholder="nom" name="shield_nom" value="{{ shield.nom }}">
                                        <button class="btn btn-outline-secondary" type="submit">Buy</button>
                                    </form>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
<script>
    // AJAX
    function sendMove(move) {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/move?move=' + move);
        xhr.send();
    }

    function sendStop() {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/stop');
        xhr.send();
    }

    function sendShoot() {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/shoot');
        xhr.send();
    }

    function sendConnection() {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/connection');
        xhr.send();
    }

    {#function sendBuyWeapon(price_weapon, weapon_name) { #}
    {#    let xhr = new XMLHttpRequest();#}
    {#    xhr.open('GET', '/buy_weapon?price_weapon=' + price_weapon, '&weapon_name=' + weapon_name);#}
    {#    xhr.send();}#}
    {##}
    {#function sendBuyShield(price_shield, shield_name) {#}
    {#    let xhr = new XMLHttpRequest();#}
    {#    xhr.open('GET', '/buy_shield?price_shield=' + price_shield, '&shield_name=' + shield_name);#}
    {#    xhr.send();}#}

    // WEBSOCKET
    const socket = io.connect("http://192.168.1.45:3000");
    socket.on("connection", function (data) {
        const data_as_json = JSON.parse(data);
        document.cookie = "websocket_sid=" + data_as_json.sid;
        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/save_websocket_sid');
        xhr.send();
    });

    socket.on("shoot_result", function (msg) {
        {#console.log("shoot_result : Message recu : ");#}
        {#console.log(msg);#}
        var div_msg = document.getElementById('msg');
        var div_pv = document.getElementById('pv');
        var div_shield = document.getElementById('shield');
        const msg_as_json = JSON.parse(msg);
        div_msg.innerHTML += msg_as_json.txt + '<br>';
        div_pv.innerHTML = msg_as_json.pv;
        div_shield.innerHTML = msg_as_json.shield;
    });
</script>
</html>